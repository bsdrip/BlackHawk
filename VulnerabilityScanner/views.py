from django.shortcuts import render

from .forms import ScanConfigForm
from .tasks import run_scan
from .models import ScanStatus


def config(request):
    if request.method == 'POST':
        scan_config_form = ScanConfigForm(request.POST)
        if scan_config_form.is_valid():
            scan_config_form.save()

            status = ScanStatus(configuration=scan_config_form.instance)
            status.save()

            run_scan.delay(
                scan_config_form.cleaned_data,
                scan_config_form.instance.id,
            )
        else:
            return render(
                request,
                'VulnerabilityScanner/config.html',
                {
                    'form': scan_config_form,
                },
            )
    else:
        scan_config_form = ScanConfigForm()
    return render(
        request,
        'VulnerabilityScanner/config.html',
        {
            'form': scan_config_form,
        },
    )
