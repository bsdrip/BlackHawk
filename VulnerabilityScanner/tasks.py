from celery import shared_task
from .scanning.vuln_scan import VulnScan
from .models import ScanResult, ScanStatus, ScanConfig


@shared_task
def run_scan(args, config_id):
    scan = VulnScan(
        scan_title=args['scan_title'],
        scan_type=args['scan_type'],
        targets=args['targets'],
        ports=args['ports'],
        udp=args['udp'],
    )
    scan.run()
    config_instance = ScanConfig.objects.get(id=config_id)

    result_json = scan.get_vulns()

    result_instance = ScanResult(
        configuration=config_instance,
        result_json=result_json,
    )
    result_instance.save()

    status_instance = ScanStatus.objects.get(
        configuration=config_instance,
    )
    status_instance.is_running = False
    status_instance.save()
