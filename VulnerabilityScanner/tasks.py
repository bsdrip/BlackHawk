from celery import shared_task
from .scanning.vuln_scan import VulnScan
from .models import Scan
from django.utils.timezone import now


@shared_task
def run_scan(args, scan_id):
    scan = VulnScan(
        scan_title=args['scan_title'],
        scan_type=args['scan_type'],
        targets=args['targets'],
        ports=args['ports'],
        udp=args['udp'],
    )
    scan.run()
    result_json = scan.get_vulns()

    config_instance = Scan.objects.get(id=scan_id)
    config_instance.result_json = result_json
    config_instance.is_running = False
    config_instance.finish_date = now()
    delta_time = config_instance.finish_date - config_instance.start_date
    config_instance.run_time = f'{delta_time.seconds // 3600} hour(s) {(delta_time.seconds // 60) % 60} minute(s) {delta_time.seconds % 60}.{delta_time.microseconds} second(s)'
    config_instance.save()
