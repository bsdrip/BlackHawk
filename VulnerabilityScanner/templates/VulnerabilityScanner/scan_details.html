{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container m-2">
<div class="row m-2">
  <div class="col-sm-11">
  <h1>Vulnerability Scan Report for <code>{{ scan.scan_title }}</code></h1>
  </div>

  <div class="dropdown col-sm-1">
    <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      Export Report
    </button>

    <ul class="dropdown-menu">
      <li><a href="{% url 'generate_report' scan_id=scan.id %}" class="dropdown-item">PDF</a></li>
      <li><a href="{% url 'generate_json' scan_id=scan.id %}" class="dropdown-item">JSON</a></li>
    </ul>
  </div>
</div>
</div>

<br>
<h3>Scan information</h3>
<hr>
<i>
<p>Scan started: {{ scan.start_date }}</p>
<p>Scan finished: {{ scan.finish_date }}</p>
<p>Scan duration: {{ scan.run_time }}</p>
</i>
<b>Vulnerabilities found:</b>
<pre>
  Critical: <span class="badge rounded-pill" style="background-color:purple;">{{ scan.result_json.vuln_numbers.critical_issues }}</span>
  High: <span class="badge bg-danger rounded-pill">{{ scan.result_json.vuln_numbers.high_issues }}</span>
  Medium: <span class="badge bg-warning rounded-pill">{{ scan.result_json.vuln_numbers.medium_issues }}</span>
  Low: <span class="badge bg-info rounded-pill">{{ scan.result_json.vuln_numbers.low_issues }}</span>
  Info: <span class="badge bg-light rounded-pill" style="color:black">{{ scan.result_json.vuln_numbers.info_issues }}</span>
</pre>

<br>
<h3>Detailed report</h3>
<hr>
{% if scan.result_json.vulnerabilities %}
{% for vuln in scan.result_json.vulnerabilities %}
<div class="accordion m-2">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#_{{ vuln.ip|replace_dots }}" aria-expanded="true" aria-controls="flush-collapseOne">
        {{ vuln.ip }}
      </button>
    </h2>
    <div id="_{{ vuln.ip|replace_dots }}" class="accordion-collapse collapse show">
      <div class="accordion-body">
        <div class="list-group">
          <div class="accordion m-1">
          <!-- PORT -->
            {% for port in vuln.ports %}
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#_{{ vuln.ip|replace_dots }}-{{ port.port }}" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                  ({{ port.port }}) {{ port.service.product }} {{ port.service.version }}
                  {% if port.vuln_numbers.critical_issues > 0 %}
                  <span class="badge rounded-pill" style="margin:5px; background-color:purple;">{{ port.vuln_numbers.critical_issues }}</span>
                  {% endif %}
                  {% if port.vuln_numbers.high_issues > 0 %}
                  <span class="badge bg-danger rounded-pill" style="margin:5px;">{{ port.vuln_numbers.high_issues }}</span>
                  {% endif %}
                  {% if port.vuln_numbers.medium_issues > 0 %}
                  <span class="badge bg-warning rounded-pill" style="margin:5px;">{{ port.vuln_numbers.medium_issues }}</span>
                  {% endif %}
                  {% if port.vuln_numbers.low_issues > 0 %}
                  <span class="badge bg-info rounded-pill" style="margin:5px;">{{ port.vuln_numbers.low_issues }}</span>
                  {% endif %}
                  {% if port.vuln_numbers.info_issues > 0 %}
                  <span class="badge bg-light rounded-pill" style="margin:5px;color:black">{{ port.vuln_numbers.info_issues }}</span>
                  {% endif %}
                </button>
              </h2>
              <div id="_{{ vuln.ip|replace_dots }}-{{ port.port }}" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <div class="accordion m-1">
                  <!-- CVE -->
                    {% for cve in port.cves %}
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button {% if cve.data.cvss.baseScore < 9.0 and cve.data.cvss.baseScore >= 7.0 %}bg-danger{% elif cve.data.cvss.baseScore < 7.0 and cve.data.cvss.baseScore >= 4.0 %}bg-warning{% elif cve.data.cvss.baseScore < 4.0 and cve.data.cvss.baseScore >= 0.1 %}bg-info{% elif cve.data.cvss.baseScore == 0.0 %}bg-light{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#_{{ vuln.ip|replace_dots }}-{{ port.port }}-{{ cve.cve }}" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne" style="color:black;{% if cve.data.cvss.baseScore >= 9.0 %}background-color:purple;{% endif %}" >
                          {{ cve.cve }}
                        </button>
                      </h2>
                      <div id="_{{ vuln.ip|replace_dots }}-{{ port.port }}-{{ cve.cve }}" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                          <p data-toggle="tooltip" title="Version: {{ cve.data.cvss.version }}&#013;Attack Vector: {{ cve.data.cvss.attackVector }}&#013;Attack Complexity: {{ cve.data.cvss.attackComplexity }}&#013;Privileges Required: {{ cve.data.cvss.privilegesRequired }}&#013;User Interaction: {{ cve.data.cvss.userInteraction }}&#013;Scope: {{ cve.data.cvss.scope }}&#013;Confidentiality Impact: {{ cve.data.cvss.confidentialityImpact }}&#013;Integrity Impact: {{ cve.data.cvss.integrityImpact }}&#013;Availability Impact: {{ cve.data.cvss.availabilityImpact }}">CVSS Vector: <code>{{ cve.data.cvss.vectorString }}</code></p>
                          <p>CVSS Score: <code>{{ cve.data.cvss.baseScore }}</code></p>
                          <p>Description: {{ cve.data.description }}</p>
                          <p><a href="https://nvd.nist.gov/vuln/detail/{{ cve.cve }}" target="_blank">More info</a></p>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% else %}
<h2>No vulnerabilities found</h2>
{% endif %}

{% endblock %}