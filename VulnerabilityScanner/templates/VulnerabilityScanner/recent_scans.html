{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
  <h1>Recent scans</h1>
  {% if completed_scans %}
  {% for scan in completed_scans %}
    {% if scan.result_json.highest_severity == 0 %}
    <div class="card border-success m-2" style="max-width: auto;">
      <div class="card-header bg-transparent">No vulnerabilities found</div>
    {% elif scan.result_json.highest_severity == 1 %}
    <div class="card border-light m-2" style="max-width: auto;">
      <div class="card-header bg-transparent">Highest severity found: <b>INFO</b></div>
    {% elif scan.result_json.highest_severity == 2 %}
    <div class="card border-info m-2" style="max-width: auto;">
      <div class="card-header bg-transparent">Highest severity found: <b>LOW</b></div>
    {% elif scan.result_json.highest_severity == 3 %}
    <div class="card border-warning m-2" style="max-width: auto;">
      <div class="card-header bg-transparent">Highest severity found: <b>MEDIUM</b></div>
    {% elif scan.result_json.highest_severity == 4 %}
    <div class="card border-danger m-2" style="max-width: auto;">
      <div class="card-header bg-transparent">Highest severity found: <b>HIGH</b></div>
    {% elif scan.result_json.highest_severity == 5 %}
    <div class="card m-2" style="max-width: auto;border-color:purple">
      <div class="card-header bg-transparent">Highest severity found: <b>CRITICAL</b></div>
    {% endif %}
      <div class="card-body">
        <h5 class="card-title">Scan Title: {{ scan.scan_title }}</h5>
        <p class="card-text">Scan Type: <b>
          {% if scan.scan_type == 'T4' %}
            Aggressive scan
          {% elif scan.scan_type == 'T2' %}
            Normal scan
          {% else %}
            Cautious scan
          {% endif %}
        </b><p>
        {% if scan.result_json.vulnerabilities %}
        {% for vulns in scan.result_json.vulnerabilities %}
          <ul class="list-group m-2">
            <li class="list-group-item"> {{ vulns.ip }}
            {% for ports in vulns.ports %}
              <div class="accordion m-2">
                <div class="accordion-item collapsed">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#_{{ scan.start_date|slugify|replace_dots }}-{{ vulns.ip|replace_dots }}-{{ ports.port }}" aria-expanded="false" aria-controls="collapseOne">
                      {{ ports.service.product }} {{ ports.service.version }} ({{ ports.port }})
                    </button>
                  </h2>
                  <div id="_{{ scan.start_date|slugify|replace_dots }}-{{ vulns.ip|replace_dots }}-{{ ports.port }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                      <ul>
                      {% for cve in ports.cves %}
                        <li><a href="https://nvd.nist.gov/vuln/detail/{{ cve.cve }}" target="_blank"><b>{{ cve.cve }}</b></a> {{ cve.data.description }} <strong>CVSS Score: </strong> <code>{{ cve.data.cvss.baseScore }}</code></li>
                      {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
            </li>
          </ul>
        {% endfor %}
        <br>
        {% endif %}
        <p class="card-text"><i>Duration: {{ scan.run_time }}</i></p>
        <a href="{% url 'scan_details' scan_id=scan.id %}" class="btn btn-light bg-light">View Details</a>
      </div>
      <div class="card-footer text-body-secondary">
        <i>
        <p class="card-text">Started at {{ scan.start_date }}</p>
        <p class="card-text">Finished at {{ scan.finish_date }}</p>
        </i>
      </div>
    </div>
  {% endfor %}
  {% else %}
    <div class="card border-light text-center" style="width: auto;">
      <div class="card-body">
        <p class="card-text"><i>Empty</i></p>
      </div>
    </div>
  {% endif %}
{% endblock %}