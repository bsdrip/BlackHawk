from nmap3 import Nmap
import json
import logging
import os
from enum import Enum


class SeverityEnum(Enum):
    NONE = 0
    INFO = 1
    LOW = 2
    MEDIUM = 3
    HIGH = 4
    CRITICAL = 5

    def __lt__(self, other):
        return self.value < other.value


class VulnScan:
    def __init__(
        self,
        scan_title,
        scan_type,
        targets,
        ports,
        udp=False,
        datetime='',
        log_level=logging.INFO,
    ):
        logging.basicConfig(level=log_level)
        self._scan_title = scan_title
        self._scan_type = scan_type
        self._targets = targets
        self._ports = ports
        self._datetime = datetime
        self._script = "--script=vulners"
        self._udp = '-sU' if udp else ''
        self._highest_severity = SeverityEnum.NONE
        self._num_of_vulns = 0
        self._critical_issues = 0
        self._high_issues = 0
        self._medium_issues = 0
        self._low_issues = 0
        self._info_issues = 0
        logging.debug(
            "Initializing vulnerability scan: nmap -sV -%s -p %s %s %s",
            self._scan_type,
            self._ports,
            self._script,
            self._targets,
        )

    def run(self):
        self.nmap = Nmap()
        logging.info("Running vulnerability scan on %s", self._targets)
        self._results = self.nmap.nmap_version_detection(
            self._targets,
            args=f'-{self._scan_type} -p {self._ports} {self._script} {self._udp}',
        )
        logging.info("Vulnerability scan complete")
        logging.info("-" * 80)
        logging.info("Results: %s\n", self._results)

    def get_vulns(self):
        logging.info("Generating vulnerability report json")
        vulns = []
        for ip in self._results:
            if ip == 'runtime':
                break
            vulns.append({"ip": ip, "ports": []})
            for port in self._results[ip]["ports"]:
                if "scripts" in port.keys():
                    for script in port['scripts']:
                        if script['name'] == 'vulners':
                            vulns[-1]['ports'].append({
                                "port": port['portid'],
                                "cves": [],
                                "service": port['service'],
                                "vuln_numbers": {
                                    "critical_issues": 0,
                                    "high_issues": 0,
                                    "medium_issues": 0,
                                    "low_issues": 0,
                                    "info_issues": 0,
                                    "all_issues": 0,
                                },
                            })
                            for cpe in script['data'].keys():
                                for cve in script['data'][cpe]['children']:
                                    if cve['type'] == 'cve':
                                        details = self._get_vuln_details(cve['id'], logging)
                                        if details['cvss'].get('baseScore') and details['cvss']['baseScore'] >= 9.0:
                                            vulns[-1]['ports'][-1]['vuln_numbers']['critical_issues'] += 1
                                            self._critical_issues += 1
                                        elif details['cvss'].get('baseScore') and details['cvss']['baseScore'] >= 7.0:
                                            vulns[-1]['ports'][-1]['vuln_numbers']['high_issues'] += 1
                                            self._high_issues += 1
                                        elif details['cvss'].get('baseScore') and details['cvss']['baseScore'] >= 4.0:
                                            vulns[-1]['ports'][-1]['vuln_numbers']['medium_issues'] += 1
                                            self._medium_issues += 1
                                        elif details['cvss'].get('baseScore') and details['cvss']['baseScore'] >= 0.1:
                                            vulns[-1]['ports'][-1]['vuln_numbers']['low_issues'] += 1
                                            self._low_issues += 1
                                        else:
                                            vulns[-1]['ports'][-1]['vuln_numbers']['info_issues'] += 1
                                            self._info_issues += 1
                                        vulns[-1]['ports'][-1]['vuln_numbers']['all_issues'] += 1
                                        vulns[-1]['ports'][-1]['cves'].append({
                                            "cve": cve['id'],
                                            "data": self._get_vuln_details(cve['id'], logging),
                                        })
        logging.info(vulns)

        vulns = [vuln for vuln in vulns if vuln['ports']]
        logging.info("Vulnerability report json generated")
        logging.info("-" * 80)
        logging.info("Vulnerabilities: %s\n", vulns)
        result = {
            "highest_severity": self._highest_severity.value,
            "vulnerabilities": vulns,
            "vuln_numbers": {
                "critical_issues": self._critical_issues,
                "high_issues": self._high_issues,
                "medium_issues": self._medium_issues,
                "low_issues": self._low_issues,
                "info_issues": self._info_issues,
                "all_issues": self._critical_issues + self._high_issues + self._medium_issues + self._low_issues + self._info_issues,
            },
        }
        return json.dumps(result)

    def _get_vuln_details(self, cve, logger):
        logger.info("Getting details for %s", cve)
        current_dir = os.path.dirname(os.path.realpath(__file__))
        filename = f'{current_dir}/resources/nvd-json-data-feeds/CVE-{cve[4:8]}/CVE-{cve[4:-2]}xx/{cve}.json'
        logger.debug("Reading %s", filename)
        with open(filename, "r") as f:
            data = json.load(f)
        description = data['descriptions'][0]['value']
        if data['metrics'].get('cvssMetricV31', None):
            cvss_data = data['metrics']['cvssMetricV31'][0]['cvssData']
        elif data['metrics'].get('cvssMetricV2', None):
            cvss_data = data['metrics']['cvssMetricV2'][0]['cvssData']
        else:
            cvss_data = {}
        base_score = cvss_data.get('baseScore', None)

        if base_score:
            if base_score == 0.0 and self._highest_severity < SeverityEnum.INFO:
                self._highest_severity = SeverityEnum.INFO
            elif base_score < 4.0 and self._highest_severity < SeverityEnum.LOW:
                self._highest_severity = SeverityEnum.LOW
            elif base_score < 7.0 and self._highest_severity < SeverityEnum.MEDIUM:
                self._highest_severity = SeverityEnum.MEDIUM
            elif base_score < 9.0 and self._highest_severity < SeverityEnum.HIGH:
                self._highest_severity = SeverityEnum.HIGH
            elif base_score >= 9.0 and self._highest_severity < SeverityEnum.CRITICAL:
                self._highest_severity = SeverityEnum.CRITICAL

        return {
            "description": description,
            "cvss": cvss_data,
        }
